Процедура ОтправитьИзменения() Экспорт
	МассивСотрудников = Новый Массив;
	УзелУТ = ПланыОбмена.ИзменениеСотрудники.НайтиПоКоду("ГСМУ_УТ");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СотрудникиИзменения.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Сотрудники.Изменения КАК СотрудникиИзменения
		|ГДЕ
		|	СотрудникиИзменения.Узел = &Узел";
	
	Запрос.УстановитьПараметр("Узел", УзелУТ);
	РезультатЗапроса = Запрос.Выполнить();	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		МассивСотрудников.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Если МассивСотрудников.Количество() > 0 Тогда
		РезультатМассив = Новый Массив;
		СпособОбмена = Константы.СпособОбменаИБ.Получить(); 
		
		Если СпособОбмена = Перечисления.СпособыОбмена.HTTP Тогда
			Для Каждого Элемент Из МассивСотрудников Цикл
				СНИЛС = Элемент.СНИЛС;
				ИНН = Элемент.ИНН;
				Наименование = Элемент.Наименование;
				ДатаРождения = Новый Структура("Год, Месяц, День", Год(Элемент.ДатаРождения), Месяц(Элемент.ДатаРождения), День(Элемент.ДатаРождения));
				ПометкаУдаления = Элемент.ПометкаУдаления;
				ДвоичныеДанные = Элемент.Фото.Получить();
				Фото = Base64Строка(ДвоичныеДанные);
				
				ДанныеСтруктура = Новый Структура;
				ДанныеСтруктура.Вставить("СНИЛС", СНИЛС);
				ДанныеСтруктура.Вставить("ИНН", ИНН);
				ДанныеСтруктура.Вставить("Наименование", Наименование);
				ДанныеСтруктура.Вставить("ДатаРождения", ДатаРождения);
				ДанныеСтруктура.Вставить("ПометкаУдаления", ПометкаУдаления);
				ДанныеСтруктура.Вставить("Фото", Фото);
				
				РезультатМассив.Добавить(ДанныеСтруктура);
			КонецЦикла;
			
			СтрокаДанных = ПреобразоватьВJSON(РезультатМассив);
			Соединение = Новый HTTPСоединение(Константы.АдресСервера.Получить(), Константы.ПортСервера.Получить(), Константы.ПользовательИБ.Получить());
			Запрос = Новый HTTPЗапрос(Константы.АдресРесурса.Получить());
			Запрос.УстановитьТелоИзСтроки(СтрокаДанных);
			Результат = Соединение.ОтправитьДляОбработки(Запрос);

			Если Результат.КодСостояния = 200 Тогда
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелУТ);
			КонецЕсли;
		Иначе
			Каталог = Константы.КаталогОбмена.Получить();
			Файл = Новый Файл(Каталог);
			
			Если Файл.Существует() Тогда
				ИмяФайла = Каталог + "\GSMU.txt";
				Файл = Новый Файл(ИмяФайла);
				ТекстДок = Новый ТекстовыйДокумент();
				
				Если Файл.Существует() Тогда
					ТекстДок.Прочитать(ИмяФайла);
					ТекущиеДанные = Новый Массив;
				
					Для Индекс = 1 По ТекстДок.КоличествоСтрок() Цикл
						СтрокаДанных = ТекстДок.ПолучитьСтроку(Индекс);
						ТекущиеДанные.Добавить(СтрокаДанных);					
					КонецЦикла;
					
					ТекстДок.Очистить();
				
					Для Каждого Элемент Из ТекущиеДанные Цикл
						ТекстДок.ДобавитьСтроку(Элемент);
					КонецЦикла;
				КонецЕсли;
				
				Для Каждого Элемент Из МассивСотрудников Цикл
					ЭлементыТЧ = Новый Массив;					
					ЭлементыТЧ.Добавить(Элемент.Наименование);
					ЭлементыТЧ.Добавить(Элемент.СНИЛС);
					ЭлементыТЧ.Добавить(Элемент.ИНН);
					ЭлементыТЧ.Добавить(Элемент.ДатаРождения);
					ЭлементыТЧ.Добавить(Элемент.ПометкаУдаления);
					СтрВыгрузка = СтрСоединить(ЭлементыТЧ, ";");
					ТекстДок.ДобавитьСтроку(СтрВыгрузка);
					
					ДвоичныеДанные = Элемент.Фото.Получить();
					Фото = Base64Строка(ДвоичныеДанные);
					ИмяФайлаИзображения = Каталог + "\" + Элемент.СНИЛС + ".txt";
					ИзображениеДок = Новый ТекстовыйДокумент;
					ИзображениеДок.ДобавитьСтроку(Фото);
					ИзображениеДок.Записать(ИмяФайлаИзображения);
				КонецЦикла;
				
				ТекстДок.Записать(ИмяФайла, КодировкаТекста.UTF8);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелУТ);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПреобразоватьВJSON(Значение) Экспорт
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Значение);
	СтрокаJSON = ЗаписьJSON.Закрыть();
	
	Возврат СтрокаJSON;
КонецФункции

&НаСервере
Функция ПолучитьДанныеИзJSON(ДанныеJSON) Экспорт
	ЧтениеДанных = Новый ЧтениеJSON;
	ЧтениеДанных.УстановитьСтроку(ДанныеJSON);
	Результат = ПрочитатьJSON(ЧтениеДанных);
	
	Возврат Результат;
КонецФункции